<!DOCTYPE HTML>
<html lang="es">
	<head>
		<title>Script que se ejecuta al apagar el equipo en Systemd</title>
		<meta charset="utf-8" />
        <meta name="theme-color" content="#222" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="https://agutierrezrodriguez.github.io/theme/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="https://agutierrezrodriguez.github.io/theme/css/main.css" />
        <link rel="stylesheet" href="https://agutierrezrodriguez.github.io/theme/css/font-awesome.min.css" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,400italic,700,700italic|Source+Code+Pro:400" />
		<!--[if lte IE 8]><link rel="stylesheet" href="https://agutierrezrodriguez.github.io/theme/css/ie8.css" /><![endif]-->
            <link href="https://agutierrezrodriguez.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Antonio Gutiérrez Atom Feed" />
	</head>
	<body>

		<!-- Header -->
			<section id="header">
				<header>
					<span class="image avatar"><img src="https://agutierrezrodriguez.github.io/theme/images/avatar.jpg" alt="" /></span>
					<h1 id="logo"><a href="/">Antonio Gutiérrez</a></h1>
 <p>SysAdmin &amp; Devops</p>				</header>
				<nav id="nav">
					<ul>
                                <li><a class="active" href="https://agutierrezrodriguez.github.io/category/linux.html">Linux</a></li>
                                <li><a href="https://agutierrezrodriguez.github.io/pages/sobre-mi.html">Sobre mí</a></li>
					</ul>
				</nav>
				<footer>
                        <ul class="icons">
                                <li><a href="https://agutierrezrodriguez.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" class="icon fa-rss"><span class="label">atom feed</span></a></li>

                                <li><a href="https://www.linkedin.com/in/antonio-gutierrez-rodriguez/" class="icon fa-linkedin"><span class="label">LinkedIn</span></a></li>
                                <li><a href="https://twitter.com/toniusco" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
                                <li><a href="https://github.com/agutierrezrodriguez/" class="icon fa-github"><span class="label">GitHub</span></a></li>
                        </ul>
				</footer>
			</section>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
<section id="one">
    <div class="container">
        <header class="major">
            <h2><a href="https://agutierrezrodriguez.github.io/script-que-se-ejecuta-al-apagar-el-equipo-en-systemd.html" rel="bookmark" title="Enlace a Script que se ejecuta al apagar el equipo en Systemd">Script que se ejecuta al apagar el equipo en Systemd</a></h2>
        </header>
        <p><div class="addthis_inline_share_toolbox"></div>
</p>
        <p><footer class="post-info">
        <abbr class="published" title="2017-10-07T17:30:00+02:00">
                Publicado el sábado 07 de octubre de 2017
        </abbr>

        <address class="vcard author">
                Por                         <a class="url fn" href="https://agutierrezrodriguez.github.io/author/antonio-gutierrez.html">Antonio Gutiérrez</a>
        </address>
<p>En <a href="https://agutierrezrodriguez.github.io/category/linux.html">Linux</a>.</p>

</footer><!-- /.post-info --></p>
        <p><p><img alt="Systemd image" src="https://agutierrezrodriguez.github.io/images/systemd.png"></p>
<p>Hay algunas veces que necesitamos ejecutar un script al apagar el sistema, como
por ejemplo una tarea de limpieza, un chequeo, una actualización, etc.</p>
<p>En sistemas con SysVinit se ponía el script en el directorio rc0.d (apagado
del sistema) y a funcionar. Con Systemd hay que realizar un archivo "unit"
para que lo entienda systemd y en dicho archivo poner el script a ejecutar.</p>
<p>Lo primero que hay que hacer es crear el archivo "unit" (configuración del
servicio) en un directorio de Systemd, yo uso /etc/systemd/system/, con el
contenido siguiente y con la extensión .service:</p>
<p>MiScriptDeApagado.service</p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">&quot;Mi script de apagado&quot;</span>
<span class="na">Before</span><span class="o">=</span><span class="s">shutdown.target</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">oneshot</span>
<span class="na">RemainAfterExit</span><span class="o">=</span><span class="s">true</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/bin/true</span>
<span class="c1"># ExecStop=&lt;Ruta del script a ejecutar o comando a ejecutar&gt;</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">&quot;date -Iseconds &gt;&gt; /var/log/apagado.log&quot;</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<p>Una vez guardado dicho archivo hay que aplicar los cambios en Systemd
reiniciando el demonio y activando el servicio de la siguiente forma</p>
<div class="highlight"><pre><span></span>systemctl daemon-reload
systemctl <span class="nb">enable</span> MiScriptDeApagado
systemctl start MiScriptDeApagado
</pre></div>


<p>Y con esto ya debería de funcionar. Actualmente lo tengo tal cual en un sistema
Debian Stretch - 9 funcionando.</p>
<p>Si tenéis cualquier duda podéis dejarme un comentario.</p>
<p>Un saludo.</p></p>
            <div class="comments">
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    var disqus_shortname = 'agutierrezrodriguez-github-io';
                    var disqus_identifier = 'script-que-se-ejecuta-al-apagar-el-equipo-en-systemd.html';
                    var disqus_url = 'https://agutierrezrodriguez.github.io/script-que-se-ejecuta-al-apagar-el-equipo-en-systemd.html';
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//agutierrezrodriguez-github-io.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Por favor, habilita javascript para ver los comentarios.</noscript>
            </div>
    </div>
</section>
					</div>

				<!-- Footer -->
					<section id="footer">
						<div class="container">
							<ul class="copyright">
								<li>&copy; Antonio Gutiérrez. Todos los derechos reservados.</li><li>Diseño: <a href="http://html5up.net">HTML5 UP</a></li>
							</ul>
						</div>
					</section>

			</div>

		<!-- Scripts -->
        <script src="theme/js/jquery.min.js"></script>
        <script src="theme/js/jquery.scrollzer.min.js"></script>
        <script src="theme/js/jquery.scrolly.min.js"></script>
        <script src="theme/js/skel.min.js"></script>
        <script src="theme/js/util.js"></script>
        <!--[if lte IE 8]><script src="theme/js/ie/respond.min.js"></script><![endif]-->
        <script src="theme/js/main.js"></script>

            <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-598f3d1eafff98c0"></script>

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-101620037-1', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'agutierrezrodriguez-github-io';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
	</body>
</html>